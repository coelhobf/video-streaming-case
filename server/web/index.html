<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paladium Video Pipeline</title>
    <style>
        body { font-family: system-ui, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .player { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .player h3 { margin: 0 0 10px 0; color: #333; }
        video { width: 100%; max-width: 500px; background: #000; }
        button { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-play { background: #007bff; color: white; }
        .btn-stop { background: #6c757d; color: white; }
        .status { margin: 10px 0; padding: 8px; border-radius: 4px; font-size: 14px; }
        .status.info { background: #e7f3ff; color: #0066cc; }
        .status.success { background: #e7f6e7; color: #006600; }
        .status.error { background: #ffe7e7; color: #cc0000; }
        .urls { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .urls code { background: white; padding: 4px; border-radius: 2px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Paladium Video Pipeline</h1>
        <p>Stream testing interface for HLS and WebRTC playback</p>

        <div class="player">
            <h3>HLS Player</h3>
            <button id="hls-play" class="btn-play">Play HLS</button>
            <button id="hls-stop" class="btn-stop">Stop</button>
            <video id="hls-video" controls playsinline></video>
            <div id="hls-status" class="status info">Ready</div>
            <div class="urls">
                <strong>HLS URL:</strong> <code>http://localhost:8888/cam1/index.m3u8</code>
            </div>
        </div>

        <div class="player">
            <h3>WebRTC Player</h3>
            <button id="rtc-play" class="btn-play">Play WebRTC</button>
            <button id="rtc-stop" class="btn-stop">Stop</button>
            <video id="rtc-video" controls playsinline muted></video>
            <div id="rtc-status" class="status info">Ready</div>
            <div class="urls">
                <strong>WebRTC URL:</strong> <code>http://localhost:8889/cam1/whep</code>
            </div>
        </div>

        <div class="player">
            <h3>External Player URLs</h3>
            <div class="urls">
                <strong>VLC RTSP:</strong> <code>rtsp://localhost:8555/cam1</code><br>
                <strong>VLC SRT:</strong> <code>srt://localhost:9998?streamid=read:cam1</code><br>
                <strong>VLC HLS:</strong> <code>http://localhost:8888/cam1/index.m3u8</code>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        // HLS Player
        const hlsVideo = document.getElementById('hls-video');
        const hlsStatus = document.getElementById('hls-status');
        let hls;

        function updateHlsStatus(msg, type = 'info') {
            hlsStatus.textContent = msg;
            hlsStatus.className = `status ${type}`;
        }

        document.getElementById('hls-play').onclick = () => {
            const src = 'http://localhost:8888/cam1/index.m3u8';
            updateHlsStatus('Starting...', 'info');
            
            if (hlsVideo.canPlayType('application/vnd.apple.mpegurl')) {
                hlsVideo.src = src;
                hlsVideo.play().then(() => updateHlsStatus('Playing (native)', 'success'))
                    .catch(err => updateHlsStatus(`Error: ${err.message}`, 'error'));
            } else if (Hls.isSupported()) {
                if (hls) hls.destroy();
                hls = new Hls({ enableWorker: true, lowLatencyMode: true });
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    updateHlsStatus('Playing (HLS.js)', 'success');
                    hlsVideo.play();
                });
                hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) updateHlsStatus(`Error: ${data.details}`, 'error');
                });
                hls.loadSource(src);
                hls.attachMedia(hlsVideo);
            } else {
                updateHlsStatus('HLS not supported', 'error');
            }
        };

        document.getElementById('hls-stop').onclick = () => {
            if (hls) { hls.destroy(); hls = null; }
            hlsVideo.pause();
            hlsVideo.src = '';
            updateHlsStatus('Stopped', 'info');
        };

        // WebRTC Player
        const rtcVideo = document.getElementById('rtc-video');
        const rtcStatus = document.getElementById('rtc-status');
        let pc;

        function updateRtcStatus(msg, type = 'info') {
            rtcStatus.textContent = msg;
            rtcStatus.className = `status ${type}`;
        }

        document.getElementById('rtc-play').onclick = async () => {
            try {
                updateRtcStatus('Connecting...', 'info');
                
                pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
                
                pc.ontrack = (ev) => {
                    rtcVideo.srcObject = ev.streams[0] || new MediaStream([ev.track]);
                    updateRtcStatus('Playing', 'success');
                };

                const offer = await pc.createOffer({ offerToReceiveVideo: true });
                await pc.setLocalDescription(offer);

                const res = await fetch('http://localhost:8889/cam1/whep', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/sdp' },
                    body: offer.sdp
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                
                const answer = await res.text();
                await pc.setRemoteDescription({ type: 'answer', sdp: answer });
                
            } catch (err) {
                updateRtcStatus(`Error: ${err.message}`, 'error');
            }
        };

        document.getElementById('rtc-stop').onclick = () => {
            if (pc) { pc.close(); pc = null; }
            if (rtcVideo.srcObject) {
                rtcVideo.srcObject.getTracks().forEach(t => t.stop());
                rtcVideo.srcObject = null;
            }
            updateRtcStatus('Stopped', 'info');
        };
    </script>
</body>
</html>